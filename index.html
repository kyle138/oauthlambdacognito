---
layout: default
---
<link href="assets/css/lightbox.min.css" rel="stylesheet">
<img src="images/CognitoOAuth.png"/>

<h5>In order to secure a single-page webapp hosted in S3 and backed up by Lambda/API Gateway, OAuth2 can be used with Cognito and a Web Identity Federation provider (eg: Google+, Facebook, etc). Steps 1-2 of this how-to will create a sample Lambda function served by API Gateway and secured using AWS-IAM. Steps 3-12 document the steps to allow a user to login to access the secured Lambda/API. If you already have a secured Lambda/API Gateway set up you can skip directly to Step 3 but I recommend reading through the first two Steps to understand how to secure your existing API Gateway resources. This how-to assumes previous experience with Lambda functions and roles.</h5>

<h2>Step 1: Create a sample Lambda function</h2>
<h5>This function expects no inputs and returns a simple message. It will be placed behind the API Gateway resource created in Step 2 and secured with AWS-IAM. It will be used for testing Cognito Authentication.</h5>

<ol>
  <li>Login to the AWS Lambda console</li>
  <li>Click on <strong>[Create a Lambda function]</strong></li>
  <li>Select the <strong>hello-world</strong> blueprint for <strong>Node.js 4.3</strong></li>
  <li>Click on <strong>[Next]</strong></li>
  <li>For Name enter <strong>hello-world</strong></li>
  <li>For Description enter <strong>A starter AWS Lambda function</strong></li>
  <li>For Runtime make sure that <strong>Node.js 4.3</strong> is selected</li>
  <li>For Code entry type make sure that <strong>Edit code inline</strong> is selected and enter the following in the code box:
    <pre><code>
'use strict';

console.log('Loading hello-world function');

exports.handler = (event, context, callback) => {
    callback(null, "Greetings and salutations.");  // Make first contact
};
    </code></pre>
  </li>
  <li>For Handler make sure <strong>index.handler</strong> entered</li>
  <li>For Role select <strong>Choose an existing role</strong></li>
  <li>For Existing Role select <strong>lambda_basic_execution</strong></li>
  <li>Leave the rest of the settings as they are and click on <strong>[Next]</strong></li>
  <li>Review the settings and click on <strong>[Create function]</strong></li>
  <li>Click on <strong>[Test]</strong> and then <strong>[Save and test]</strong> the result "Greetings and salutations" should be returned</li>
</ol>

<h2>Step 2: Create sample API Gateway</h2>
<h5>This API Gateway will be serve sample Lambda function created in Step 1. Once it is secured with AWS-IAM it will not be accessible without Cognito authorization.</h5>

<ol>
  <li>Login to the AWS API Gateway console</li>
  <li>Click on <strong>[Create API]</strong></li>
  <li>Select <strong>New API</strong></li>
  <li>For API Name enter <strong>hello-world</strong></li>
  <li>For Description enter <strong>Sample API Gateway for hello-world lambda</strong></li>
  <li>Pulldown the <strong>Action</strong> menu and select <strong>Create Resource</strong></li>
  <li>For Resource Name enter <strong>sample</strong> which should autopopulate Resource Path with <strong>/sample</strong></li>
  <li>Make sure the <strong>Enable API Gateway CORS</strong> box is checked</li>
  <li>Click on <strong>[Create Resource]</strong></li>
  <li>Make sure the newly created <strong>/sample</strong> resource is highlighted and pull down the <strong>Actions</strong> menu and select <strong>Create Method</strong></li>
  <li>From the pulldown menu select <strong>GET</strong> and click the checkmark</li>
  <li>For Integration Type select <strong>Lambda Function</strong></li>
  <li>For Lambda Region select the region your Lambda function was created in</li>
  <li>For Lambda Function enter <strong>hello-world</strong></li>
  <li>Click on <strong>[Save]</strong></li>
  <li>Click <strong>[OK]</strong></li>
  <li>Click on <strong>Test</strong> and then click on <strong>[Test]</strong>, the Response Body should be "Greetings and salutations."</li>
  <li>Click on <strong><- Method Execution</strong> to return to the Method page and click on <strong>Method Request</strong></li>
  <li>Click on the Pencil icon next to <strong>Authorization</strong></li>
  <li>Select <strong>AWS_IAM</strong> and click on the checkmark</li>
  <li>Click on <strong><- Method Execution</strong></li>
  <li>In the <strong>Method Request</strong> box locate and copy down the <strong>ARN:</strong> string, this will be used in Step 9.7</li>
  <li>In the Resources panel highlight the <strong>/sample</strong> resource</li>
  <li>Pull down the <strong>Actions</strong> menu and select <strong>Enable CORS</strong></li>
  <li>Click on <strong>[Enable CORS and replace existing CORS headers]</strong></li>
  <li>Click on <strong>[Yes, replace existing values]</strong></li>
  <li>In the Resources panel highlight the root <strong>/</strong> resource</li>
  <li>Pull down the <strong>Actions</strong> menu and select <strong>Deploy API</strong></li>
  <li>For Deployment Stage select <strong>[New Stage]</strong></li>
  <li>For Stage Name enter <strong>prod</strong></li>
  <li>For Stage Description enter <strong>production</strong></li>
  <li>Click on <strong>[Deploy]</strong></li>
  <li>This should take you to the <strong>prod Stage Editor</strong> page and the <strong>Invoke URL</strong> should be highlighted in blue at the top of the page. However, if you attempt to Invoke this URL you will receive <strong>{"message": "Missing Authentication Token"}</strong> because we enabled AWS_IAM Authorization</li>
  <li>Click on the <strong>SDK Generation</strong> tab</li>
  <li>Pull down the <strong>Platform</strong> menu and select <strong>Javascript</strong></li>
  <li>Click on <strong>[Generate SDK]</strong></li>
  <li>Download and save the generated <strong>javascript_{date}.zip</strong> file as it will be needed in Step 10.5</li>
</ol>

<h2>Step 3: Create S3 bucket to host the single-page webapp</h2>
<h5>The frontend html and js files will be hosted in S3. A bucket will need to be created and configured for website hosting.</h5>

<ol>
  <li>Login to the AWS S3 console</li>
  <li>Click on <strong>[Create Bucket]</strong></li>
  <li>Give the bucket a globally unique name, select a region, and click on <strong>[Create]</strong></li>
  <li>Select the new bucket, click on <strong>[Properties]</strong> and click on <strong>Permissions</strong></li>
  <li>Click on <strong>[Add bucket policy]</strong> and enter the following: (replace NAMEOFBUCKET below with the name of the bucket you just created)
  <pre><code>
    {
    	"Version": "2012-10-17",
    	"Statement": [
    		{
    			"Sid": "PublicReadGetObject",
    			"Effect": "Allow",
    			"Principal": "*",
    			"Action": "s3:GetObject",
    			"Resource": "arn:aws:s3:::NAMEOFBUCKET/*"
    		}
    	]
    }
  </code></pre>
  </li>
  <li>Click on <strong>Static Website Hosting</strong> > <strong>Enable website hosting</strong></li>
  <li>For Index Document enter <strong>index.html</strong> and click <strong>Save</strong></li>
  <li>Copy the Endpoint: link provided as we will be using it in the Step 4.8.b and Step 10.3.a</li>
</ol>
<a href="images/3.1-S3-CreateBucket.png" data-lightbox="Step3" >S3 - Create Bucket</a>
<img src="images/3.2-S3-AddPolicy.png" alt="S3 - Add Policy" />
<img src="images/3.3-S3-EnableWebsiteHosting.png" alt="S3 - Enable Website Hosting" />
<img src="images/3.4-S3-Endpoint.png" alt="S3 - Get Endpoint" />

<h2>Step 4: Create Project and Enable Google+ API in Google Developer Console</h2>
<h5>A Web Identity Federation provider will be used to handle authentication so that end users can use an account they already have rather than creating a separate one for this page. In this example we will use Google+.</h5>

<ol>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
</ol>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"/>
<script src="assets/js/lightbox.min.js"/>
